---
import Layout from '@app/layout/Layout.astro';
import NotionContent from '@features/blog/pages/NotionContent.astro';
import StructuredData from '@shared/components/StructuredData.astro';
import { getAllPosts } from "@content/blog";
import type { NotionBlogPost } from '@features/blog/models/NotionBlogPost';


export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post: NotionBlogPost) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

console.log("üîç Post data:", post);
console.log("üìù Post content length:", post.content?.length);


// Si no hay post, redirigir a 404
if (!post) {
  return Astro.redirect('/404');
}

// Asegurarnos de que tenemos todos los datos necesarios
const { title, date, tags, coverImage, content, description } = post;

// Datos para el schema Article
const siteUrl = Astro.site?.href || 'https://carlosquinza.es';
const articleUrl = `${siteUrl}/blog/${post.slug}`;
const formattedDate = new Date(post.date).toISOString();

const articleStructuredData = {
  headline: post.title,
  description: post.description,
  image: post.coverImage || `${siteUrl}/images/personal_images/personal.webp`,
  datePublished: formattedDate,
  dateModified: formattedDate,
  authorName: 'Carlos Quinz√°',
  authorUrl: siteUrl,
  publisherName: 'Carlos Quinz√° - Portfolio',
  publisherLogo: `${siteUrl}/images/personal_images/personal.webp`,
  url: articleUrl,
  keywords: post.tags,
  articleSection: 'Tecnolog√≠a',
  inLanguage: 'es-ES'
};

// Datos para el schema Breadcrumb
const breadcrumbStructuredData = {
  breadcrumbs: [
    { name: 'Inicio', url: siteUrl },
    { name: 'Blog', url: `${siteUrl}/blog` },
    { name: post.title, url: articleUrl }
  ]
};
---

<Layout 
  title={post.title}
  description={post.description}
  image={post.coverImage}
  type="article"
  date={post.date}
  tags={post.tags}
  url={`/blog/${post.slug}`}
>
  <!-- Structured Data -->
  <StructuredData type="Article" data={articleStructuredData} />
  <StructuredData type="BreadcrumbList" data={breadcrumbStructuredData} />

  <div class="min-h-screen bg-[#f9fafb] pt-24">
    {/* Hero section */}
    <div class="relative h-[50vh] min-h-[400px] w-full overflow-hidden">
      {post.coverImage && (
        <img
          src={post.coverImage}
          alt={`Imagen de portada para ${post.title}`}
          class="absolute inset-0 h-full w-full object-cover"
          loading="eager"
          decoding="async"
        />
      )}
      <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/40 to-black/80" />
      <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" />
      <div class="relative z-10 flex h-full items-center justify-center px-4">
        <div class="text-center text-white">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">{post.title}</h1>
          <p class="text-lg md:text-xl opacity-90">
            {new Date(post.date).toLocaleDateString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </p>
        </div>
      </div>
    </div>

    {/* Content Section */}
    <div class="container mx-auto px-4 py-12">
      <div class="max-w-4xl mx-auto">
        {/* Tags */}
        {tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-8">
            {tags.map((tag: string) => (
              <span class="px-3 py-1 text-sm font-medium text-[#4f46e5] bg-[#eef2ff] rounded-full">
                {tag}
              </span>
            ))}
          </div>
        )}

        {/* Description */}
        {description && (
          <div class="text-xl text-[#4b5563] mb-8 italic">
            {description}
          </div>
        )}

        {/* Main Content */}
        <NotionContent content={post.content} />

        {/* Back to Blog Link */}
        <div class="mt-12 text-center">
          <a
            href="/blog"
            class="inline-flex items-center px-6 py-3 bg-[#4f46e5] text-white font-medium rounded-lg hover:bg-[#4338ca] transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Volver al blog
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>
